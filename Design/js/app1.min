angular.module("ngApp").factory("AddressHelper",["$timeout","$q","$http",function(e,t,r){return new function(){var e={fields:["display_name","pincode","id","type","location","city_name","city","area","street","22landmark"],limit:10},o=function(o,n,a){var s=angular.copy(e);s.city_id=o,s.type=a,s.term=n;var i=t.defer();return r.get("/bbplacessearch/getplaces",{params:s,dont_show_loader:!0}).then(function(e){i.resolve(e.data.response)}).catch(function(){i.reject(!1)}),i.promise};this.getCities=function(){var e=t.defer();return r.get("/member/get-cities/").then(function(t){e.resolve(t.data)}).catch(function(){e.reject(!1)}),e.promise},this.getAreas=function(e,t){return o(e,t,"area")},this.getPincodes=function(e,t){return o(e,t,"pincode")},this.getApartments=function(e,t){return o(e,t,"apartment")}}}]),angular.module("ngApp").factory("broadcastService",["$rootScope",function(e){return{send:function(t,r){e.$broadcast(t,r)}}}]),angular.module("ngApp").factory("Checkout",["$timeout","$q","$http","MyAccount","broadcastService","BBSnowPlow",function(e,t,r,o,n,a){var s={DELIVERY_ADDRESS:"delivery_address",GIFT_OPTIONS:"gift_options",DELIVERY_OPTIONS:"delivery_options",PAYMENT_OPTIONS:"payment_options"},i={STANDARD:"normal",DARKSTORE_EXPRESS:"darkstore-express"},d={};d[s.DELIVERY_ADDRESS]="address_listing",d[s.GIFT_OPTIONS]="gift_section",d[s.DELIVERY_OPTIONS]="delivery_options",d[s.PAYMENT_OPTIONS]="payment_section";var c=1e3,l=1005,_={MEMBER_INACTIVE:1001,PO_EXPIRED:1002,BASKET_REDIRECT:1003,SLOT_REDIRECT:1004,ADDRESS_SELECTION:1006},u={BASKET_REDIRECT:112,MEMBER_INACTIVE:104},p={RESTART_CHECKOUT:100,REDIRECT_TO_BASKET:101,REDIRECT_TO_LOGIN:102,RELOAD_DELIVERY_PREFERENCES:103,PO_EXPIRED:104},m={};return m[_.MEMBER_INACTIVE]=p.REDIRECT_TO_LOGIN,m[_.BASKET_REDIRECT]=p.REDIRECT_TO_BASKET,m[_.SLOT_REDIRECT]=p.RELOAD_DELIVERY_PREFERENCES,m[_.ADDRESS_SELECTION]=p.RESTART_CHECKOUT,m[_.PO_EXPIRED]=p.PO_EXPIRED,m[u.BASKET_REDIRECT]=p.REDIRECT_TO_BASKET,m[u.MEMBER_INACTIVE]=p.REDIRECT_TO_LOGIN,new function(){var e,_,h,f,v={},g=!1;this.STEP=s,this.STEPS_SEQUENCE=[s.DELIVERY_ADDRESS,s.GIFT_OPTIONS,s.DELIVERY_OPTIONS,s.PAYMENT_OPTIONS],this.FULFILLMENT_TYPE=i,this.ERROR_CODE=p;var y;v.order_summary={},v.use_bb_wallet=!0,v.benefit_type=void 0,this.init=function(){var e=t.defer();return this.getOrderSummary().then(function(t){y=angular.copy(t.delivery_address),v.order_summary=angular.copy(t.order_summary),y.is_partial||(v.delivery_address=angular.copy(y)),S(v.order_summary),v.order_summary.force_bb_wallet_use=Number(v.order_summary.wallet_bal)<0,t.order_summary=v.order_summary,e.resolve(t)}).catch(function(t){e.reject(t)}),e.promise},this.getSPScreenView=function(e){return SPScreenViews.checkout[d[e]]},this.getOrderSummary=function(){var e=t.defer();return r.get("/co/order-summary/").then(function(t){var r=t.data;r.error_code===c||r.error_code===l?e.resolve(t.data.details):(r.error_code=m[r.error_code],e.reject(r))}).catch(function(t){e.reject(t.data)}),e.promise},this.getInitialDeliveryAddress=function(){return y},this.getDeliveryAddress=function(){return v.delivery_address},this.hasDeliveryAddress=function(){return!!v.delivery_address},this.getSavedAddresses=function(){var e=t.defer();return o.getAddresses().then(function(t){t||(t=[]);var r=!0,n=o.findOne({is_default:!0},t);if(!n)return e.resolve([]);y.is_partial&&n.city_id===y.city_id&&(r=!0);var a=o.findOne({is_partial:!0},t);r&&a&&t.splice(a.index,1),y.is_partial&&a&&(delete a.number,a.nick="Incomplete Address"),e.resolve(t)}).catch(function(t){e.reject(t)}),e.promise},this.setCity=function(e){e||(e=v.delivery_address);var o={city_id:e.city_id,address_id:e.addr_id},n=t.defer();return r.post("/set-city/",o).then(function(e){n.resolve(e)}).catch(function(e){n.reject()}),n.promise},this.reviewBasketCheck=function(){var e=this,o={city_id:v.delivery_address.city_id,address_id:v.delivery_address.addr_id},n=t.defer();return r.post("/set-city/",o).then(function(t){e.updatePo().then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)})}).catch(function(e){n.reject()}),n.promise},this.updatePo=function(){var e="";e=v.delivery_address?v.delivery_address.addr_id:k("addr");var o=t.defer(),n=this,a={addr_id:e};return r.post("/co/update-po/",a).then(function(e){1e3===e.data.error_code?n.qcCheck().then(function(e){o.resolve(e)}).catch(function(e){o.reject(e)}):e.data.error_code&&(1003===e.data.error_code&&(e.data.error_code=m[e.data.error_code],e.data.msg=e.data.message,e.data.error_code=p.REDIRECT_TO_BASKET),o.reject(e.data))}).catch(function(e){o.reject(e)}),o.promise};var b=function(e){var t=[];for(var r in e)t=t.concat(e[r]);return t};this.qcCheck=function(){var o=t.defer();return r.post("/co/qc/stock/").then(function(t){if(t.data.error_code_num===u.BASKET_REDIRECT?(t.data.error_code=m[u.BASKET_REDIRECT],o.reject(t.data)):t.data.error_code_num===u.MEMBER_INACTIVE&&(t.data.error_code=m[u.MEMBER_INACTIVE],o.reject(t.data)),t.data.qc_details){var r=b(t.data.qc_details.qc_dict),n=b(t.data.qc_details.promo_qc_list);if(n.length>0||r.length>0){var s=[];s.promoProductList=n,s.productList=r,s.success=t.data.success,s.error_msg_display=t.data.error_msg_display,s.pre_qc_count=t.data.pre_qc_count,s.post_qc_count=t.data.post_qc_count,s.error_code_num=t.data.error_code_num,s.error_code=t.data.error_code;var i=[],d=[];angular.forEach(r,function(e){"Out of stock"==e.status?i.push(""+e.product_id):d.push(""+e.product_id)});var c={NoOfItemsAvailable:s.pre_qc_count,NoOfItemsPartiallyAvailable:d.length,NoOfItemsNotAvailable:i.length,ItemsNotAvailable:i,ItemsPartiallyAvailable:d};e=c,a.sendEvent(SPEvents.checkout.qc_shown,c),o.reject(s)}}else t.data.error_code_num?o.reject(t.data):o.resolve(t)}).catch(function(e){o.reject(e)}),o.promise},this.setDeliveryAddress=function(e){var o=t.defer();v.delivery_address=angular.copy(e);var n=this,a={city_id:v.delivery_address.city_id,address_id:v.delivery_address.addr_id};return r.post("/basket/get-cart-item-difference/",a).then(function(t){if(y.city_id!==v.delivery_address.city_id)t.data.migrate_cart_items||t.data.items.length>0&&t.data.show_popup,t.data.initial_place=y.area,t.data.selected_place=v.delivery_address.area,P(t.data),o.reject(t.data);else{if(!(t.data.items.length>0||t.data.show_popup))return n.setCity(e).then(function(){n.updatePo().then(function(e){o.resolve(t.data)}).catch(function(e){o.reject(e)})}),o.promise;y.area!==v.delivery_address.area&&(t.data.initial_place=y.area,t.data.selected_place=v.delivery_address.area),P(t.data),o.reject(t.data)}}).catch(function(){o.reject(!1)}),o.promise},this.clearDeliveryAddress=function(){v.delivery_address=void 0},this.getGiftProducts=function(){var e=t.defer();return r.get("/co/gift-products/").then(function(t){t.data.details?e.resolve(t.data.details):(t.data.error_code=m[t.data.error_code],t.data.msg=t.data.message,e.reject(t.data))}).catch(function(t){e.reject(t)}),e.promise},this.saveGiftMessage=function(e){var o=t.defer();return r.post("/co/gift-products/",e).then(function(e){o.resolve(e.data)}).catch(function(e){o.reject(e)}),o.promise},this.getDeliveryPreferences=function(){var e=t.defer();return r.get("/co/delivery-preferences-new/").then(function(t){if(t.data.error_code===c||t.data.error_code===l)e.resolve(t.data);else{t.data.error_code=m[t.data.error_code];var r={EventSubGroup:"Delivery Preference",FailureReason:t.data.message};a.sendEvent(SPEvents.checkout.error,r),e.reject(t.data)}}).catch(function(t){e.reject(t)}),e.promise},this.setDeliveryPreferences=function(e){for(var o=t.defer(),n=[],s=e.shipments.length,i=0;i<s;i++){var d={};d.slot_date=e.shipments[i].selected.slot_date,d.slot_id=e.shipments[i].selected.slot_id,d.bb_star_avail=e.shipments[i].selected.bb_star_avail,d.shipment_id=e.shipments[i].shipment_id,d.fulfillment_id=e.shipments[i].fulfillment_id,d.linked_shipments=e.shipments[i].linked_shipments,n.push(d)}return n={book_slots:n},r.post("/co/delivery-preferences-new/",JSON.stringify(n)).then(function(e){var t=e.data.error_code;if(t===c||t===l)g=!0,o.resolve(e);else{e.data.error_code=m[e.data.error_code];var r={EventSubGroup:"Delivery Preference",FailureReason:e.data.message};a.sendEvent(SPEvents.checkout.error,r),o.reject(e.data)}}).catch(function(e){o.reject(e)}),o.promise},this.deleteItems=function(e){for(var o=t.defer(),n=[],a=e.length,s=this,i=0;i<a;i++)if(e[i].delete){var d={};d.sku=e[i].sku,d.quantity=e[i].no_items_in_cart,d.del_quantity=e[i].no_items_in_cart,n.push(d)}return n={item_list:n},r.post("/co/delete-item/",JSON.stringify(n)).then(function(e){var t=e.data.error_code;t===c||t===l?(o.resolve(e.data),s.init()):(e.data.error_code=m[e.data.error_code],o.reject(e.data))}).catch(function(e){o.reject(e)}),o.promise},this.applyVoucher=function(e,o,n){var a=this;o||(o="cod");var s={voucher_code:e,paymentmethod:o},i=t.defer();return r.post("/order/apply-evoucher/",s).then(function(t){var r=t.data,o=r.result,s=!1;if("unknown"===o)s="Your checkout session has expired. Please start the checkout process again."===r.message?r.message:"Error in assigning this voucher "+r.message;else if("min_order"===o)s="Minimum order value not met "+r.message;else if("zero_selective_order"===o)s="Voucher category not present in cart "+r.message;else if("expired"===o)s="This offer is now closed "+r.message;else if("invalid"===o)s=" "+r.message;else if("evoucher_error_message"===o)s=" "+r.message;else if("excluded"===o)s="Products Excluded from Voucher  "+r.message;else{v.benefit_type=t.data.benefit_type;var d={evoucher_credit_amount:t.data.result,evoucher_code:e,is_bbwallet_used:n};E(d).then(function(e){t.status="success","cashback"===e.data.benefit_type?t.pop_msg="Cashback will be credited to your account within 48 hours of your order delivery":t.pop_msg=void 0,e.data.success_message?t.msg=e.data.success_message:t.msg="Voucher applied",t.details=d,t.data.use_bbwallet_enabled=e.data.use_bbwallet_enabled,i.resolve(t),a.init()})}s&&(i.reject({status:"failed",msg:s,data:t.data}),a.init())}).catch(function(e){i.reject(e)}),i.promise},this.removeVoucher=function(){var e=t.defer(),o=this;return r.post("/co/remove-evoucher/").then(function(t){t.data.success?e.resolve(t.data):e.reject({status:"failed",msg:"Cannot remove the voucher",data:t.data}),o.init()}).catch(function(t){e.reject(t),o.init()}),e.promise},this.useWallet=function(e){var o={use_wallet:e=!!e},n=t.defer();return r.post("/order/use_wallet/",o,{dont_show_loader:!0}).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)}),n.promise};var E=function(e){var o=t.defer();return r.post("/order/get_voucher_data/",e).then(function(e){o.resolve(e)}).catch(function(e){o.reject(e)}),o.promise};this.getpaymentOptions=function(){var e=t.defer();return r.get("/order/new_payment_methods/").then(function(t){e.resolve(t.data)}).catch(function(){e.reject(!1)}),e.promise},this.getWalletOtp=function(e,o,n){var a={mobile_number:e,resend:o},s=t.defer(),i="/payment/"+n+"/wallet/link/otp/";return r.get(i,{params:a}).then(function(e){e.data={status:0,message:"",response:{}},s.resolve(e.data)}).catch(function(e){s.reject(e)}),s.promise},this.verifyOtp=function(e,o){var n={otp:e},a=t.defer(),s="/payment/"+o+"/wallet/link/otp/";return r.post(s,n).then(function(e){a.resolve(e.data)}).catch(function(e){a.reject(e)}),a.promise},this.getBalance=function(e){var o=t.defer(),n="/payment/"+e+"/wallet/balance/";return r.get(n).then(function(e){o.resolve(e.data)}).catch(function(e){o.reject(e)}),o.promise},this.getBalanceAsync=function(e,o,n){var a=t.defer(),s="/payment/"+e+"/wallet/balance/";return r.get(s,{dont_show_loader:!0}).then(function(e){e.data.option_count=o,e.data.item_count=n,a.resolve(e.data)}).catch(function(e){a.reject(e)}),a.promise},this.placeOrder=function(e,o,n){var s=t.defer(),i={paymentmode:e,deduct_from_wallet:o,default_pm:n};return r.post("/order/place_web_order/",i).then(function(t){t.data;var r=t.data.error_code;if(r===c)window.location="cod"===e?"/co/complete/orderv2/":"/co/orderwait/?redir=/payment/all/redirect",s.resolve(t);else if(r===l)window.location="/co/complete/orderv2/",s.resolve(t);else{t.data.error_code=m[t.data.error_code];var o={EventSubGroup:"payment",FailureReason:t.data.message};t.data.msg=t.data.message,a.sendEvent(SPEvents.checkout.error,o),s.reject(t.data)}}).catch(function(e){s.reject(e)}),s.promise};var w=function(e){var t=Number(v.order_summary.used_token),r=Number(v.order_summary.remaining_token),o=0,n=e.shipments,a=0,s=0;for(n.sort(function(e,t){return Number(t.delivery_charge)-Number(e.delivery_charge)}),o=t+r,t=0,s=0;s<n.length;s++)n[s].delivery_charge>0&&o&&(o--,t++,a+=Number(n[s].delivery_charge));r=o,v.order_summary.used_token=t,v.order_summary.remaining_token=r,v.order_summary.delivery_token=a},S=function(){h&&(w(f),v.order_summary.delivery_charge=f.total_delivery_charge);var e=v.order_summary;v.use_bb_wallet?e.total=(Number(e.sub_total)+Number(e.delivery_charge)+Number(e.gift_wrap_charge)-Number(e.wallet_bal)).toFixed(2):e.total=(Number(e.sub_total)+Number(e.delivery_charge)+Number(e.gift_wrap_charge)).toFixed(2),v.order_summary.evoucher_credit_amount&&["BANK","immediate"].includes(v.benefit_type)&&(e.total=(Number(e.total)-Number(v.order_summary.evoucher_credit_amount)).toFixed(2)),e.delivery_token&&(e.total-=e.delivery_token),e.total<0&&(e.total=(0).toFixed(2)),e.wallet_remaining=(Number(e.wallet_bal)-(Number(e.sub_total)+Number(e.delivery_charge)+Number(e.gift_wrap_charge)-Number(e.delivery_token))).toFixed(2),v.order_summary.evoucher_credit_amount&&"immediate"===v.benefit_type&&(e.wallet_remaining=(Number(e.wallet_remaining)+Number(v.order_summary.evoucher_credit_amount)).toFixed(2)),v.use_bb_wallet||(e.wallet_remaining=Number(e.wallet_bal).toFixed(2)),v.use_bb_wallet?e.wallet_remaining<0?e.wallet_amt_used=Number(e.wallet_bal).toFixed(2):e.wallet_amt_used=(e.wallet_bal-e.wallet_remaining).toFixed(2):e.wallet_amt_used=(0).toFixed(2),n.send("refreshOrderSummary",v.order_summary)};this.setBBWalletUsage=function(e,t){v.use_bb_wallet=e,t||S()},this.isBillAmountEqualToZero=function(){return!!v.use_bb_wallet&&("0.00"===v.order_summary.total||0===v.order_summary.total)},this.getWalletselection=function(){return!!v.use_bb_wallet},this.refreshOrderSummary=function(e){f=e,v.order_summary.delivery_charge=e.total_delivery_charge,w(e),S()},this.handleQcContinueSplow=function(){a.sendEvent(SPEvents.checkout.qc_continue_clicked,e)},this.handleQcReviewSplow=function(){a.sendEvent(SPEvents.checkout.qc_review_clicked,e)},this.handleApplyVoucherSplow=function(e){_={VoucherCode:e.evoucher_code,VoucherDiscountAmt:Number(e.evoucher_credit_amount)},a.sendEvent(SPEvents.checkout.voucher_applied,_)},this.handleRemoveVoucherSplow=function(){a.sendEvent(SPEvents.checkout.voucher_removed,_)},this.getSplowFiList=function(e){for(var t=[],r=0;r<e.shipments.length;r++)t.push(e.shipments[r].fulfillment_type);return t},this.processSnowPlowDeliveryID=function(e,t){var r={fulfillment_id:"FulfillmentID",delivery_day:"DeliveryDay",slot_id:"SlotID",rule_id:"RuleID",delivery_fee:"DeliveryFee"};e=e.delivery_id;var o=[];if(t)for(var n=t.shipments.length,a=0;a<n;a++)t.shipments[a].selected&&(e[a].slot_id=t.shipments[a].selected.slot_id);for(var s=0;s<e.length;s++){for(var i="",d=Object.keys(e[s]),c=Object.values(e[s]),l=0;l<d.length;l++)i+=r[d[l]]+":"+c[l],l!==d.length-1&&(i+=",");o.push(i)}return o},this.deliveryOptionsIsOpen=function(){h=!0},this.deliveryOptionsIsClose=function(){h=!1};var P=function(t){for(var r=k("spni"),o=[],n=0;n<t.items.length;n++)o.push(""+t.items[n].skuid);var s={NoOfItemsAvailable:r-o.length,NoOfItemsNotAvailable:o.length,ItemsNotAvailable:o};e=s,a.sendEvent(SPEvents.checkout.qc_shown,s)},k=function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var r=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null}}}]),angular.module("ngApp").factory("MyAccount",["$timeout","$q","$http",function(e,t,r){return new function(){var e,o,n=[];this.getAddresses=function(){var e=t.defer();return r.get("/member/get-member-address/").then(function(t){n=angular.copy(t.data.addresses||[]),e.resolve(n)}).catch(function(){e.reject(!1)}),e.promise},this.getPartialAddress=function(){return n&&(o=this.findOne({is_partial:!0},n)),o},this.getProfile=function(){},this.findOne=function(e,t){for(var r,o=0;o<t.length;o++){var n=!0;for(var a in e)if(t[o][a]!==e[a]){n=!1;break}if(n){(r=t[o]).index=o;break}}return r},this.saveAddress=function(o){var a=t.defer();o.is_default=o.is_default?1:0;var s=this;return r.post("/member/create-address/",o).then(function(t){var i=t.data.validation_errors||{};if(Object.keys(i).length>0){var d=angular.copy(i),c={contact_number:"number",contact_area:"area",contact_zipcode:"pin"};for(var l in i)c[l]&&(d[c[l]]=i[l]);return a.reject(d)}var _=s.findOne({is_default:!0},n);s.getAddresses().then(function(n){var i=!1,d=s.findOne({addr_id:t.data.address_id},n);if(d.is_default&&(_&&_.is_partial&&(_=void 0),_&&_.number===d.number||(i=!0)),!i)return a.resolve(d);var c={};c.mobile_no=o.number,r.post("/auth/member/send-otp/",c).then(function(t){d.is_otp_verification_required=!0,e=o,a.resolve(d)}).catch(function(e){a.reject(!1)})}).catch(function(){a.reject(!1)})}),a.promise},this.verifyAddressOTP=function(o){var n={mobile_no:e.number,code:o},a=t.defer();return r.post("/member/validate-otp/",n,{dont_show_loader:!0}).then(function(t){if(t.data.success)e=void 0,a.resolve();else{var r=t.data.message;a.reject(r)}}).catch(function(){a.reject(!1)}),a.promise},this.resendAddressOTP=function(){var o,n={},a=t.defer();return n.mobile_no=e.number,r.post("/auth/member/send-otp/",n,{dont_show_loader:!0}).then(function(e){o="Code sent succesfully",a.resolve(o)}).catch(function(e){o="Please Try again",a.reject(o)}),a.promise}}}]),angular.module("ngApp").directive("addressCard",function(){return{restrict:"E",templateUrl:"address-card.html",scope:{address:"=address"}}}),angular.module("ngApp").directive("addressCardDescription",function(){return{restrict:"E",templateUrl:"address-card-description.html",scope:{address:"=address"}}}),angular.module("ngApp").directive("allowOnlyNumbers",function(){return{restrict:"A",link:function(e,t,r,o){t.on("keydown",function(e){var t=this.value;return t=t.replace(/[^0-9]/g,""),64!=e.which&&16!=e.which&&(e.which>=48&&e.which<=57||(e.which>=96&&e.which<=105||([8,9,13,27,37,38,39,40].indexOf(e.which)>-1||(e.preventDefault(),!1))))})}}}),angular.module("ngApp").directive("slotSelection",function(){return{restrict:"E",templateUrl:"slot_selection.html",scope:{daywiseSlotGroups:"=",selected:"=",data:"=",onSelect:"&",useCapacity:"=",mergedSlots:"=",comboMessage:"="},link:function(e,t,r){},controller:["$scope",function(e){function t(t){e.selectedSlot=angular.copy(t);var r=e.selectedSlot.slot_date.toLowerCase(),o=e.selectedSlot.slot.toLowerCase();-1!==r.indexOf("tomorrow")&&-1!==o.indexOf("tomorrow")&&(e.selectedSlot.slot_date="")}e.is_open=!1,e.changeSelected=function(r){r&&(r.blocked||(e.selected=angular.copy(r),t(e.selected)),e.is_open=!e.is_open,e.onSelect({slot:angular.copy(r),data:angular.copy(e.data)}))},e.current_day_idx=0,e.$watch("daywiseSlotGroups",function(){e.daywiseSlotGroups&&function(){for(var r=!1,o=e.daywiseSlotGroups.length,n=0,a=0;n<o;n++){e.dayGrp=e.daywiseSlotGroups[n],e.dayGrp.is_day_closed=!0,e.dayGrp.is_day_blocked=!1,e.dayGrp.date=e.dayGrp.slot_date.split(",")[0],e.dayGrp.day=e.dayGrp.slot_date.split(",")[1],e.daySlotGrp=e.daywiseSlotGroups[n].slots[0];var s=e.daySlotGrp.length;for(a=0;a<s;a++)e.daySlotGrp[a].blocked&&(e.daywiseSlotGroups[n].is_day_blocked=!0),e.daySlotGrp[a].available&&(r||(e.selected=e.daySlotGrp[a],t(e.selected),e.current_day_idx=n,r=!0),e.daywiseSlotGroups[n].is_day_closed=!1)}}()}),e.$watch("selected",function(t,r){if(t!==r)for(var o=e.daywiseSlotGroups.length,n=0;n<o;n++)e.selected.slot_date===e.daywiseSlotGroups[n].slot_date&&(e.current_day_idx=n)})}]}}),angular.module("ngApp").controller("DeliveryAddress",["$scope","$timeout","$q","$uibModal","$rootScope","MyAccount","AddressHelper","Checkout","BBSnowPlow",function(e,t,r,o,n,a,s,i,d){e.ID=i.STEP.DELIVERY_ADDRESS,e.is_collapsed=!0,e.CITIES=[],e.addresses=[],e.edit_mode=!1,e.othernickname=!1,e.draft={},e.input={otp:void 0,selected_address:void 0},e.is_edit_address=!1,e.errors={number:void 0,area:void 0,city:void 0,pin:void 0,residentialcomplex:void 0,otp_error:void 0},e.register(e.ID,e),e.init=function(){e.delivery_address=i.getInitialDeliveryAddress(),console.log(e.delivery_address),e.addresses=[],e.edit_mode=!1,e.draft={},e.input={otp:void 0,selected_address:void 0}},e.load=function(){var t=r.defer();return i.getSavedAddresses().then(function(r){if(i.hasDeliveryAddress()){e.delivery_address=i.getDeliveryAddress();for(var o=0,n=r.length;o<n;o++)if(e.delivery_address.addr_id===r[o].addr_id){r[o].is_selected=!0,e.input.selected_address=r[o];break}}if(0===r.length)e.edit(),e.is_saved_address_exists=!1;else{if(e.is_edit_address){d.sendEvent(SPEvents.checkout.checkout_address_shown,{Action:"edit"})}else d.sendEvent(SPEvents.checkout.checkout_address_shown);e.is_edit_address=!1,e.addresses=r,e.edit_mode=!1,e.is_saved_address_exists=!0}t.resolve()}).catch(function(e){t.reject(e)}),t.promise},e.isComplete=function(){return!!i.hasDeliveryAddress()&&(e.delivery_address=i.getDeliveryAddress(),!0)},e.showAddressListing=function(){e.is_edit_address=!0,e.expand(e.ID)},e.selectDeliveryAddress=function(t,r){if(e.input.selected_address&&(e.input.selected_address.is_selected=!1),t.is_selected=!0,e.input.selected_address=t,t.is_partial)e.edit(t);else{if(r||d.sendEvent(SPEvents.checkout.delivery_address_selected),e.delivery_address.addr_id!==t.addr_id){var o={InitialCityID:e.delivery_address.city_id,FinalCityID:t.city_id};d.sendEvent(SPEvents.checkout.delivery_address_changed,o)}i.setDeliveryAddress(t).then(function(t){e.gotoNextStep()}).catch(function(t){t.error_code===i.ERROR_CODE.REDIRECT_TO_BASKET?e.handleError(t):t.productList||t.promoProductList?e.showQcModal(t):t.items&&(e.qc_content=t,e.qc_list=t.items,e.item_count=e.qc_list.length,e.showQcCartModal())})}},e.loadCities=function(t){s.getCities().then(function(t){e.CITIES=t}).catch(function(){})},e.loadAreas=function(t){s.getAreas(e.draft.city_id,t.search).then(function(t){e.AREAS=t.results}).catch(function(){})},e.loadPincodes=function(t){s.getPincodes(e.draft.city_id,t.search).then(function(t){e.PINCODES=t.results}).catch(function(){})},e.loadApartments=function(t){var o=r.defer();return s.getApartments(e.draft.city_id,t).then(function(t){e.APARTMENTS=t.results,o.resolve(e.APARTMENTS)}).catch(function(){}),o.promise},e.handleCityChange=function(t){e.draft.city_id=t.id,e.errors.area="Please select a Location/Area/Zone",e.errors.pin="Please select a valid Pincode",e.draft.obj_area=void 0,e.draft.obj_pincode=void 0},e.handleAreaChange=function(t){e.errors.area=void 0,e.errors.pin=void 0,e.draft.obj_pincode=angular.copy(t)},e.handlePincodeChange=function(t){e.errors.area="Please select a Location/Area/Zone",e.errors.pin=void 0,e.draft.obj_area=void 0},e.cancelEdit=function(){e.edit_mode=!1},e.edit=function(t){d.sendEvent(SPEvents.checkout.delivery_address_added),e.edit_mode=!0,e.draft=angular.copy(t||a.getPartialAddress()||e.delivery_address),e.draft.nick_type="home",delete e.draft.nick,e.draft.is_partial?e.draft.number=void 0:delete e.draft.address1,delete e.draft.is_default,e.draft.obj_city={id:e.draft.city_id,name:e.draft.city_name},e.draft.obj_area={id:"",display_name:e.draft.area},e.draft.obj_pincode={id:"",pincode:e.draft.pin},0===e.CITIES.length&&e.loadCities()},e.save=function(t){t&&(t.preventDefault(),t.stopPropagation()),e.errors={};var r={};if(["addr_id","first_name","last_name","number","address1","address2","landmark","nick","is_default","apartment_id"].forEach(function(t){r[t]=e.draft[t]}),"other"!==e.draft.nick_type&&(r.nick=c(e.draft.nick_type)),delete r.addr_id,void 0===r.number||""===r.number)e.errors.number="Please enter a valid mobile number";else{r.number.match(/^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/)||(e.errors.number="Please enter a valid mobile number")}e.draft.address1||(e.errors.address1="Please enter house number"),e.draft.obj_city||(e.errors.city="Please select a City"),e.draft.obj_area.display_name||(e.errors.area="Please select a Location/Area/Zone"),e.draft.obj_pincode.pincode||(e.errors.pin="Please select a Pincode");var o=!1;for(var n in e.errors)if(e.errors[n]){o=!0;break}o||(r.city_id=e.draft.obj_city.id,r.pin=e.draft.obj_pincode.pincode,r.area=e.draft.obj_area.display_name,r.area_id=e.draft.obj_area.id,r.residentialcomplex=e.draft.residentialcomplex.display_name,r.apartment_id=e.draft.residentialcomplex.id,a.saveAddress(r).then(function(t){t.is_otp_verification_required?(e.unverified_address=t,e.input.otp="",e.showOtpModal()):(e.errors={},e.edit_mode=!1,e.selectDeliveryAddress(t,!0))}).catch(function(t){e.errors=t}))},e.showQcCartModal=function(){e.qc_cart_dlg=o.open({ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"qc_cart_dlg.html",backdrop:"static",scope:e}),e.qc_cart_dlg.result.then(function(e){}).catch(function(e){})},e.reviewBasket=function(){e.qc_cart_dlg.dismiss("cancel"),i.setCity().then(function(e){window.location.href="/basket/"}).catch(function(e){104==e.error_code_num?window.location.href="/auth/login/":112!=e.error_code_num&&1003!==e.error_code||(window.location.href="/basket/")})},e.handleCartContinue=function(){e.qc_cart_dlg.dismiss("cancel"),i.handleQcContinueSplow(),i.setCity().then(function(){i.updatePo().then(function(t){e.gotoNextStep(),n.$broadcast("MainPageLoadComplete")}).catch(function(t){n.$broadcast("MainPageLoadComplete"),t.productList||t.promoProductList?(e.qc_content=t,e.qc_list=t.productList,e.qc_promo_list=t.promoProductList,e.qc_list&&(e.item_count=e.qc_list.length),e.qc_promo_list&&(e.item_count+=e.qc_promo_list.length),e.showQcModal(t)):104===t.error_code_num?window.location.href="/auth/login/":112===t.error_code_num||1003===t.error_code?window.location.href="/basket/":e.handleError(t)})})},e.showOtpModal=function(){e.otp_dlg=o.open({ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"otp_modal.html",backdrop:"static",size:"md",windowClass:"otp_dlg",scope:e}),e.otp_dlg.result.then(function(){}).catch(function(e){})},e.closeOtpDlg=function(){e.otp_dlg.dismiss("cancel")},e.verifyOTP=function(t){t&&(t.preventDefault(),t.stopPropagation()),a.verifyAddressOTP(e.input.otp).then(function(t){e.errors.opt_error=void 0,e.otp_dlg.dismiss(),e.selectDeliveryAddress(e.unverified_address,!0)}).catch(function(t){e.errors.opt_error=t})},e.resendOTP=function(){a.resendAddressOTP().then(function(t){e.errors.opt_error=void 0,e.otp_resent_message=t}).catch(function(t){e.errors.opt_error=t})};var c=function(e){return e.charAt(0).toUpperCase()+e.slice(1)}}]),angular.module("ngApp").controller("DeliveryOptions",["$scope","$rootScope","$uibModal","$timeout","$q","BBSnowPlow","BBScreenView","Checkout",function(e,t,r,o,n,a,s,i){e.ID=i.STEP.DELIVERY_OPTIONS,e.is_collapsed=!0,e.register(e.ID,e),e.selected_shipment_group=void 0,e.display_total_delivery_charge=void 0,e.is_others_expanded=!0,e.use_capacity=!1,e.combo_message="",e.delivery_id_group=[],e.voucher_benefit_type=void 0,e.is_delivery_pref_selected=!1,e.init=function(){console.log("initialize delivery options")},e.load=function(){var t=n.defer();return e.is_delivery_pref_selected=!1,i.getDeliveryPreferences().then(function(r){var o={InitialFI:i.getSplowFiList(r.details.shipment_groups[0])};r.details.benefit_type&&(e.voucher_benefit_type=r.details.benefit_type),a.sendEvent(SPEvents.checkout.address_slot_shown,o),e.postProcessDeliveryPreference(r),t.resolve()}).catch(function(t){e.handleError(t)}),t.promise},e.clear=function(){},e.isComplete=function(){return e.is_delivery_pref_selected},e.edit=function(){e.expand(e.ID)},e.expandOtherOptions=function(){e.limit=e.shipment_groups.length,e.is_others_expanded=!0},e.expandShipmentGroup=function(t){if(!e.selected_shipment_group||e.selected_shipment_group.index!==t.index){var r=e.shipment_groups[0].shipments.length,o=!1;if(r===t.shipments.length)for(var n=0;n<r;n++){if(e.shipment_groups[0].shipments[n].fulfillment_type!==t.shipments[n].fulfillment_type){o=!0;break}o=!1}else o=!0;if(o){var s={InitialFI:i.getSplowFiList(e.shipment_groups[0]),FinalFI:i.getSplowFiList(t)};a.sendEvent(SPEvents.checkout.non_default_delivery_option_clicked,s)}for(var d=0,c=e.shipment_groups.length;d<c;d++)e.shipment_groups[d].is_collapsed=!0;e.selected_shipment_group=t,e.selected_shipment_group.is_collapsed=!1,i.refreshOrderSummary(angular.copy(t))}},e.handleExpand=function(t,r){r!==e.selected_shipment_group.index&&(e.shipment_groups[e.selected_shipment_group.index].isCollapsed=!0,t.isCollapsed=!1,e.selected_shipment_group.index=r,e.selected_shipment_group=e.shipment_groups[e.selected_shipment_group.index])},e.proceed2Payment=function(t){t&&(t.preventDefault(),t.stopPropagation());e.selected_shipment_group.index;e.selected_shipment_group=e.shipment_groups[e.selected_shipment_group.index],e.selected_shipment_group.is_collapsed=!1,i.setDeliveryPreferences(e.selected_shipment_group).then(function(){e.is_delivery_pref_selected=!0,i.deliveryOptionsIsClose(),!e.voucher_benefit_type||"bank"!==e.voucher_benefit_type.toLowerCase()&&"paytm_cashback"!==e.voucher_benefit_type.toLowerCase()||i.removeVoucher(),e.gotoNextStep();var t={InitialFI:i.getSplowFiList(e.shipment_groups[0]),FinalFI:i.getSplowFiList(e.selected_shipment_group)};a.sendEvent(SPEvents.checkout.proceed_to_pay_clicked,t)}).catch(function(t){e.handleError(t,e.proceed2Payment)})},e.viewItems=function(t,o){e.shipment_modal=angular.copy(t),e.index_order=o,e.count_deleted=0,e.dlg_view_items=r.open({ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"items_dlg.html",scope:e,size:"md"}),s.send(SPScreenViews.checkout.shipment_items_popup),e.dlg_view_items.result.then(function(){}).catch(function(){console.log("Modal dismissed at: "+new Date)});for(var n=i.getSplowFiList(e.selected_shipment_group),d=[],c=0;c<t.sku_list.length;c++)d.push(""+t.sku_list[c].sku);var l={NoOfItemsAvailable:t.item_count,ItemsAvailable:d,FinalFI:n};a.sendEvent(SPEvents.checkout.view_shipment_items,l)},e.removeItem=function(t){e.count_deleted++,t.delete=!0},e.addItem=function(t){e.count_deleted--,t.delete=!1},e.deleteItems=function(t){for(var r=i.getSplowFiList(e.selected_shipment_group),o=t.length,n=[],s=0;s<o;s++)t[s].delete&&n.push(""+t[s].sku);var d={ItemsRemoved:n,FinalFI:r};a.sendEvent(SPEvents.checkout.remove_items_confirm,d),i.deleteItems(t).then(function(t){e.dlg_view_items.dismiss("cancel"),e.postProcessDeliveryPreference(t)}).catch(function(t){e.dlg_view_items.dismiss("cancel"),e.handleError(t,e.deleteItems)})},e.closeItemsListDlg=function(){e.dlg_view_items.dismiss("cancel")},e.postProcessDeliveryPreference=function(t){e.shipment_groups=t.details.shipment_groups,e.shipment_groups[0].index=0;for(var r=1,o=e.shipment_groups.length;r<o;r++)e.shipment_groups[r].is_collapsed=!0,e.shipment_groups[r].index=r;e.selected_shipment_group=e.shipment_groups[0],e.non_jit_index=t.details.non_jit_index,e.use_capacity=t.details.is_city_5k,e.combo_message=t.details.combo_message,e.more_option_message=t.details.more_option_message,i.refreshOrderSummary(e.shipment_groups[0])},e.handleSlotSelection=function(t,r){if(t.blocked){e.shipments=e.shipment_groups[e.non_jit_index].shipments;for(var o=0,n=e.shipments.length;o<n;o++)e.shipments[o].fulfillment_type===i.FULFILLMENT_TYPE.STANDARD&&(t.blocked=!1,e.shipments[o].selected=t,e.expandOtherOptions());e.expandShipmentGroup(e.shipment_groups[e.non_jit_index])}},e.$on("refreshOrderSummary",function(t,r){e.display_total_delivery_charge=r.delivery_charge})}]),angular.module("ngApp").controller("GiftOptions",["$scope","$q","Checkout","BBSnowPlow",function(e,t,r,o){e.ID=r.STEP.GIFT_OPTIONS,e.is_collapsed=!0,e.removed_gift_message=!1,e.is_optional=!0,e.draft={},e.gift_info=void 0,e.register(e.ID,e),e.gift_items=[],e.init=function(){console.log("initialize gift options")},e.load=function(){e.removed_gift_message=!1;var n=t.defer();return r.getGiftProducts().then(function(t){e.gift_info=t.gift_info,e.draft=angular.copy(t.gift_info),e.gift_items=t.items,n.resolve();var r={NoOfGiftItems:e.gift_items.length};o.sendEvent(SPEvents.checkout.gifting_shown,r)}).catch(function(e){n.reject(e)}),n.promise},e.isComplete=function(){return e.is_collapsed},e.editGiftMessage=function(){e.expand(e.ID)},e.saveGiftMessage=function(t){t&&(t.preventDefault(),t.stopPropagation());var n=angular.copy(e.draft);n.msg?r.saveGiftMessage(n).then(function(t){var r={NoOfGiftItems:e.gift_items.length};o.sendEvent(SPEvents.checkout.save_gifting,r),e.gift_info=angular.copy(n),e.gotoNextStep(e.ID)}).catch(function(t){e.handleError(t)}):e.removeGiftMessage().then(function(){e.gotoNextStep(e.ID)}).catch(function(t){e.handleError(t)})},e.removeGiftMessage=function(n){var a=angular.copy(e.gift_info);delete a.msg,delete a.rec_name;var s=t.defer(),i={NoOfGiftItems:e.gift_items.length};return o.sendEvent(SPEvents.checkout.gift_delete,i),r.saveGiftMessage(a).then(function(){return e.gift_info=angular.copy(a),e.removed_gift_message=!0,s.resolve()}).catch(function(t){return e.handleError(t)}),s.promise},e.cancelEditGiftMessage=function(){e.gotoNextStep(e.ID)},e.restrictMessageLength=function(){e.draft.msg&&e.draft.msg.length>250&&(e.draft.msg=e.draft.msg.substr(0,250))}}]),angular.module("ngApp").controller("Main",["$scope","$q","$uibModal","$rootScope","$timeout","BBSnowPlow","BBScreenView","Account","Checkout",function(e,t,r,o,n,a,s,i,d){var c,l={},_={},u=[],p=!1;e.input={voucher_code:void 0,use_bb_wallet:!0},e.selected_voucher=void 0,e.applied_voucher=void 0,e.is_voucher_applied=!1,e.voucher_warning_msg=void 0,e.msg=void 0,e.current_step=void 0,e.v_success=void 0,e.popover_open=!1,e.is_v_open=!1,e.is_t_open=!1,e.error_count=0;e.init=function(){i.me().then(function(e){a.init(e.config.snow_plow),s.init()}).catch(function(){});for(var t,r,n=0,c=(u=d.STEPS_SEQUENCE).length;n<c;n++)t={id:u[n]},r&&(r.next=t,t.prev=r),r=t,_[t.id]=t;e.current_step=_[u[0]],d.init().then(function(t){t.promote_bbstar_member.show_trial_or_pay_msg?e.hide_bbstar_section=!1:e.hide_bbstar_section=!0,p=!0,e.order_summary=t.order_summary,e.vouchers=t.vouchers;for(var r in _)_[r].ctrl=l[r],_[r].ctrl.init();for(var n=e.current_step;n&&n.ctrl&&n.ctrl.isComplete();)n=n.next;e.current_step=n,e.expand(e.current_step.id).then(function(){o.$broadcast("MainPageLoadComplete")}).catch(function(e){o.$broadcast("MainPageLoadComplete")})}).catch(function(t){e.handleError(t)})},e.register=function(e,t){l[e]=t,t.is_collapsed=!0},e.gotoNextStep=function(){for(console.log(e.current_step);e.current_step.next&&e.current_step.next.ctrl.is_optional;)e.current_step.ctrl.is_collapsed=!0,e.current_step=e.current_step.next;e.current_step.next?d.init().then(function(){e.current_step.ctrl.is_collapsed=!0,console.log("About to expand : ",e.current_step.next.id),e.expand(e.current_step.next.id)}).catch(function(t){e.handleError(t)}):console.log("This condition should never hit!")},e.expand=function(r){var o=t.defer();if(e.isEnabled(r)){c=r;var n=l[r];for(var a in l)l[a].is_collapsed=!0;n.is_collapsed=!1,e.current_step=_[r],n.load().then(function(){var e=d.getSPScreenView(c);e&&s.send(e),"delivery_options"===c?d.deliveryOptionsIsOpen():d.deliveryOptionsIsClose(),c=void 0,o.resolve()}).catch(function(t){e.handleError(t),o.resolve()})}return o.promise},e.isEnabled=function(e){for(var t=!0,r=_[e];r.prev;){if(!r.prev.ctrl.isComplete()){t=!1;break}r=r.prev}return t},e.restart=function(){window.location.reload()},e.showVoucherList=function(t){t&&(t.preventDefault(),t.stopPropagation()),e.dlg_vouchers=r.open({ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"voucher_list_dlg.html",scope:e,size:"lg"}),e.applied_voucher?e.selected_voucher=angular.copy(e.applied_voucher):e.selected_voucher=void 0,a.sendEvent(SPEvents.checkout.vouchers_shown),s.send(SPScreenViews.checkout.vouchers_popup),e.dlg_vouchers.result.then(function(){}).catch(function(){})},e.closeVoucherWarningDlg=function(){e.dlg_vouchers&&e.dlg_vouchers.close()},e.closeVoucherListDlg=function(){e.dlg_vouchers&&e.dlg_vouchers.close()},e.showVoucherWarning=function(t){t&&(t.preventDefault(),t.stopPropagation()),e.dlg_vouchers=r.open({ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"voucher_warning_dlg.html",scope:e,size:"sm",backdrop:"static",windowTopClass:"voucher_warning"}),e.applied_voucher?e.selected_voucher=angular.copy(e.applied_voucher):e.selected_voucher=void 0,e.dlg_vouchers.result.then(function(){console.log("Voucher warning modal then")}).catch(function(){console.log("Voucher warning modal closed at : "+new Date)})},e.proceedRemoveVoucher=function(){e.removeVoucher(),e.dlg_vouchers&&e.dlg_vouchers.close(),e.input.use_bb_wallet=!0},e.handleVoucherWarningClose=function(){e.dlg_vouchers&&e.dlg_vouchers.close(),e.input.use_bb_wallet=!1,e.handleBBWalletToggle()},e.toggleApplyVoucher=function(t){t&&(t.preventDefault(),t.stopPropagation()),e.is_voucher_applied?e.removeVoucher():e.applyVoucher()},e.removeVoucher=function(){e.voucher_warning_msg=void 0,d.removeVoucher(e.input.voucher_code).then(function(t){!0===t.success?(e.v_success=!1,e.is_voucher_applied=!1,e.v_msg="Voucher removed",e.input.voucher_code=void 0,e.applied_voucher=void 0,e.selected_voucher=void 0,d.handleRemoveVoucherSplow(),n(function(){e.v_msg=void 0},5e3)):console.log(t)}).catch(function(t){e.v_msg=t.msg,n(function(){e.v_msg=void 0},5e3),e.v_success=!1})},e.applyVoucherDialog=function(){e.dlg_vouchers&&(e.dlg_vouchers.close(),e.dlg_vouchers=void 0,e.input.voucher_code=e.selected_voucher.code),e.applyVoucher()},e.applyVoucher=function(){e.applied_voucher=void 0,d.applyVoucher(e.input.voucher_code,null,e.input.use_bb_wallet).then(function(t){"success"===t.status?(e.v_success=!0,e.v_msg=t.msg,e.v_cashback_msg=t.pop_msg,e.is_voucher_applied=!0,e.applied_voucher={code:t.details.evoucher_code},!1===t.data.use_bbwallet_enabled&&(e.input.use_bb_wallet=!1,e.handleBBWalletToggle(!0)),d.handleApplyVoucherSplow(t.details)):e.v_msg=void 0}).catch(function(t){e.v_success=!1,e.v_msg=t.msg;var r={VoucherCode:e.input.voucher_code,FailureReason:e.v_msg};a.sendEvent(SPEvents.checkout.voucher_apply_failed,r),"Your checkout session has expired. Please start the checkout process again."===t.msg?e.handleError(t):n(function(){e.v_msg=void 0},5e3)})},e.toggleVoucherTermsAndConditions=function(e){e.is_terms_expanded=!e.is_terms_expanded},e.selectVoucher=function(t){e.selected_voucher=t},e.handleError=function(t,r){switch(e.showError(t),e.retry_fn=r,t.message&&!t.msg&&(t.msg=t.message),t.error_code){case d.ERROR_CODE.RESTART_CHECKOUT:console.log("Restarting Checkout. Unhandled exception. Reason: "+t.msg),d.updatePo().then(function(){e.init(),e.error_count+=1,e.error_count>=2&&(window.location.href="/")}).catch(function(t){e.handleQCResponse(t)});break;case d.ERROR_CODE.RELOAD_DELIVERY_PREFERENCES:console.log("Restarting DeliveryPreference. Reason: "+t.msg),e.expand(d.STEP.DELIVERY_OPTIONS),e.openSlotExpiredPopup(t.msg);break;case d.ERROR_CODE.REDIRECT_TO_LOGIN:console.log("Restarting DeliveryPreference. Reason: "+t.msg),window.location.href="/auth/login/";break;case d.ERROR_CODE.REDIRECT_TO_BASKET:e.openBasketEmptyPopup(t.msg);break;case d.ERROR_CODE.PO_EXPIRED:p?d.updatePo().then(function(){d.init().then(function(){c?e.expand(c):e.retry_fn&&e.retry_fn()}).catch(function(t){e.handleError(t)})}).catch(function(t){e.handleQCResponse(t)}):d.updatePo().then(function(){e.init()}).catch(function(t){e.handleQCResponse(t)});break;default:console.log(t),e.restartCheckoutPopup()}},e.showError=function(e){e.msg&&console.log("Error occured. Reason: "+e.msg)},e.restartCheckoutPopup=function(t){e.msg=t,e.dlg_basket_empty=r.open({ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"restart_checkout_dlg.html",scope:e,size:"sm",backdrop:"static",keyboard:!1})},e.handleQCResponse=function(t){t.productList||t.promoProductList?(e.processQc(t),e.showQcModal()):104===t.error_code_num?window.location.href="/auth/login/":112!==t.error_code_num&&1003!==t.error_code&&t.error_code!==d.ERROR_CODE.REDIRECT_TO_BASKET||(window.location.href="/basket/")},e.showQcModal=function(t){t&&e.processQc(t),e.qc_stock_dlg=r.open({ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"qc_stock_dlg.html",backdrop:"static",scope:e}),s.send(SPScreenViews.checkout.qc_popup),e.qc_stock_dlg.result.then(function(e){}).catch(function(e){})},e.handleQcContinue=function(){e.qc_stock_dlg.dismiss("cancel"),d.handleQcContinueSplow(),c?e.expand(c):e.retry_fn?e.retry_fn():e.gotoNextStep()},e.openBasketEmptyPopup=function(t){e.msg=t,e.dlg_basket_empty=r.open({ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"basket_empty_dlg.html",scope:e,size:"sm",backdrop:"static",keyboard:!1})},e.openSlotExpiredPopup=function(t){e.msg=t,e.dlg_slot_expired=r.open({ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"po_slot_expired_dlg.html",scope:e,size:"sm",backdrop:"static",keyboard:!1})},e.restartCheckout=function(){window.location.reload()},e.closeSlotExpiredPopup=function(){e.dlg_slot_expired.dismiss("cancel")},e.redirectToBasket=function(){d.handleQcReviewSplow(),window.location="/basket/"},e.redirectToHome=function(){window.location="/"},e.toggleBBWallet=function(){e.is_voucher_applied&&1==e.input.use_bb_wallet&&void 0!==e.voucher_warning_msg?(e.handleBBWalletToggle(),e.showVoucherWarning()):e.handleBBWalletToggle()},e.handleBBWalletToggle=function(t){d.setBBWalletUsage(e.input.use_bb_wallet,t),d.useWallet(angular.copy(e.input.use_bb_wallet)).then(function(t){t.data.voucher_removal_warning&&(e.voucher_warning_msg=t.data.voucher_removal_warning)}),e.input.use_bb_wallet?(e.input.use_bb_wallet=!0,a.sendEvent(SPEvents.checkout.bbwallet_checked)):(e.input.use_bb_wallet=!1,a.sendEvent(SPEvents.checkout.bbwallet_uncheked))},e.processQc=function(t){e.qc_content=t,e.qc_list=t.productList,e.qc_promo_list=t.promoProductList,e.qc_list&&(e.item_count=e.qc_list.length),e.qc_promo_list&&(e.item_count+=e.qc_promo_list.length)},e.$on("refreshOrderSummary",function(t,r){e.order_summary=r,null===r.evoucher_credit_amount&&!0===e.is_voucher_applied&&(e.is_voucher_applied=!1,e.v_success=!1,e.v_msg="Voucher removed",n(function(){e.v_msg=void 0},5e3),e.input.voucher_code=void 0,e.selected_voucher=void 0,e.applied_voucher=void 0),r.force_bb_wallet_use&&(e.input.use_bb_wallet=!0)}),e.$on("subscribeToBBStar",function(e){d.init()})}]),angular.module("ngApp").controller("paymentOptions",["$scope","$q","$timeout","Checkout","BBSnowPlow",function(e,t,r,o,n){e.ID=o.STEP.PAYMENT_OPTIONS,e.is_collapsed=!0,e.place_order_msg=void 0,e.register(e.ID,e),e.init=function(){},e.load=function(){var r=t.defer();return o.getpaymentOptions().then(function(t){e.payment_methods=t.pm_methods,e.paymentOption=[],e.selected_payment_group_inx=0,e.show_order_placement=!1;var a=e.payment_methods.length;e.defaultAll=!0;for(s=0;s<a;s++)e.payment_methods[s].isCollapsed=!0,e.paymentOption[s]=null,e.payment_methods[s].group==t.show&&(e.selected_payment_group_inx=s,e.paymentMethod=e.payment_methods[s].group,e.payment_methods[s].isCollapsed=!1,"pm_default"==e.payment_methods[s].group&&(e.payment_methods[s].items[0].is_default=!0,e.defaultAll=!1),e.paymentOption[s]=e.payment_methods[s].items[0].value,e.show_order_placement=!0,e.handlePaymentSelection(e.payment_methods[s].items[0]));for(var s=0;s<a;s++)for(var i=e.payment_methods[s].items.length,d=0;d<i;d++){var c=e.payment_methods[s].items[d];if(c.first_class&&c.is_linked&&!c.wallet_loaded){var l=c.value;o.getBalanceAsync(l,s,d).then(function(t){var r=e.payment_methods[t.option_count].items[t.item_count];r.wallet_loaded=!0,r.place_order_msg=void 0,t.response&&(r.prepend_text=t.response.prepend_text),r.disable_wallet=!1,0===t.status&&(r.walletAvailable=!0,r.walletBalance=t.response.wallet_balance),1001===t.status&&(r.show_error=!0,r.first_class=!1,r.show_error_messsage="Error. Try Other Payment Option"),1002===t.status&&(r.walletAvailable=!1,r.is_linked=!1,r.link_failure=!0),1003===t.status&&(r.bill_pay_msg=t.message,r.place_order_msg="Place Order & Settle Bill"),1004===t.status&&(r.disable_wallet=!0,r.disable_wallet_msg=t.message)}).catch(function(){})}}r.resolve(),n.sendEvent(SPEvents.checkout.payment_shown)}).catch(function(){r.reject()}),r.promise},e.handleExpand=function(t,r){r!==e.selected_payment_group_inx&&(e.selectedItem=null,e.paymentOption[e.selected_payment_group_inx]=null,e.paymentMethod=t.group,e.payment_methods[e.selected_payment_group_inx].isCollapsed=!0,t.isCollapsed=!1,e.selected_payment_group_inx=r,e.paymentOption[r]=t.items[0].value,e.handlePaymentSelection(t.items[0]))},e.$on("refreshOrderSummary",function(t,r){e.payment_use_bb_wallet=o.getWalletselection(),e.allowOnlyWalletPayment=o.isBillAmountEqualToZero(),e.allowOnlyWalletPayment?(e.disablePayment&&(e.disablePaymentState=!0),e.disablePayment=!1):(e.disablePaymentState&&(e.disablePayment=!0),e.disablePaymentState=!1),e.allowOnlyWalletPayment?(e.place_order_msg&&(e.place_order_msg_state=angular.copy(e.place_order_msg)),e.place_order_msg=void 0):(e.place_order_msg_state&&(e.place_order_msg=angular.copy(e.place_order_msg_state)),e.place_order_msg_state=!1)}),e.handlePaymentSelection=function(t){if(t.place_order_msg?e.place_order_msg=t.place_order_msg:e.place_order_msg=void 0,!e.selectedItem){e.selectedItem=t;var r=!0}if((e.selectedItem.value!=t.value||r)&&(t.otp_step1=!1,t.otp_step2=!1,e.payment_option=t.value,e.disablePayment=!1,e.selectedItem=t,e.show_order_placement=!0,t.show_error&&(e.disablePayment=!0),t.first_class&&!t.is_linked&&(t.otp_step1=!0,e.disablePayment=!0),t.first_class&&t.is_linked&&!t.wallet_loaded&&(e.disablePayment=!0),!t.initialize&&(t.initialize=!0,t.is_default||(t.setDefault=e.defaultAll),t.wallet_loaded&&t.show_error&&(e.disablePayment=!0),t.wallet_loaded&&t.link_failure&&(t.otp_step1=!0,e.disablePayment=!0),t.first_class&&t.is_linked&&!t.wallet_loaded))){var n=t.value;o.getBalance(n).then(function(r){t.wallet_loaded=!0,t.place_order_msg=void 0,r.response&&(t.prepend_text=r.response.prepend_text),t.disable_wallet=!1,0===r.status&&(t.walletAvailable=!0,t.walletBalance=r.response.wallet_balance,e.disablePayment=!1),1001===r.status&&(t.show_error=!0,e.disablePayment=!0,t.first_class=!1,t.show_error_messsage="Error. Try Other Payment Option"),1002===r.status&&(t.walletAvailable=!1,t.is_linked=!1,t.otp_step1=!0,e.disablePayment=!0),1003===r.status&&(t.bill_pay_msg=r.message,t.place_order_msg="Place Order & Settle Bill",e.disablePayment=!1),1004===r.status&&(t.disable_wallet=!0,t.disable_wallet_msg=r.message)}).catch(function(){})}},e.sendNumber=function(t,r){t.resend>=0?t.resend++:t.resend=0,t.number=r,o.getWalletOtp(r,t.resend,t.value).then(function(r){switch(r.status){case 0:t.otp_step1=!1,t.otp_step2=!0;break;case 1001:t.otpStep1Error=!0,t.otpStep1ErrorMessage=r.message;break;case 1002:t.otp_step2=!1,t.otp_step3=!0,e.otpStep2Error=!0,t.otpStep2ErrorMessage=r.message}}).catch(function(){})},e.sendOtp=function(t,n){t.otpStep1Error=!1,e.place_order_msg=void 0,o.verifyOtp(n,t.value).then(function(n){switch(n.response&&(t.prepend_text=n.response.prepend_text),n.status){case 0:t.otp_step2=!1,t.otp_step3=!0,t.is_linked=!0;var a=t.value;e.disablePayment=!1,o.getBalance(a).then(function(e){t.wallet_loaded=!0,t.walletAvailable=!0,t.walletBalance=e.response.wallet_balance,t.is_linked=!0}).catch(function(){}),r(function(){t.otp_step3=!1},4e3);break;case 1001:t.otpStep2Error=!0,t.otpStep2ErrorMessage=n.message;break;case 1002:t.otp_step2=!1,t.otp_step3=!0,e.disablePayment=!1,e.otpStep2Error=!0;break;case 1003:t.otp_step2=!1,t.otp_step3=!0,t.is_linked=!0,e.disablePayment=!1,t.bill_pay_msg=n.message,t.place_order_msg="Place Order & Settle Bill",e.place_order_msg=t.place_order_msg,r(function(){t.otp_step3=!1},4e3);break;case 1004:t.otp_step2=!1,t.otp_step3=!0,t.is_linked=!0,t.disable_wallet=!0,t.disable_wallet_msg=n.message,e.disablePayment=!0,r(function(){t.otp_step3=!1},4e3)}}).catch(function(){})},e.resendOtp=function(t){t.otpStep2Error=!1,t.resend++,o.getWalletOtp(t.number,t.resend,t.value).then(function(r){switch(r.status){case 0:t.otp_step1=!1,t.otp_step2=!0;break;case 1001:t.otpStep1Error=!0,t.otpStep1ErrorMessage=r.message;break;case 1002:t.otp_step2=!1,t.otp_step3=!0,e.otpStep2Error=!0,t.otpStep2ErrorMessage=r.message}}).catch(function(){})},e.placeOrder=function(){var t=e.allowOnlyWalletPayment?"cod":e.selectedItem.value,r=!1;e.selectedItem&&(r=!e.allowOnlyWalletPayment&&e.selectedItem.setDefault),o.placeOrder(t,e.payment_use_bb_wallet,r).then(function(e){n.sendEvent(SPEvents.checkout.place_order_clicked)}).catch(function(t){e.handleError(t)})}}]);